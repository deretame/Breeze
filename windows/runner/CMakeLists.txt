cmake_minimum_required(VERSION 3.14)
project(runner LANGUAGES CXX)

# Define the application target. To change its name, change BINARY_NAME in the
# top-level CMakeLists.txt, not the value here, or `flutter run` will no longer
# work.
#
# Any new source files that you add to the application should be added here.
add_executable(${BINARY_NAME} WIN32
  "flutter_window.cpp"
  "main.cpp"
  "utils.cpp"
  "win32_window.cpp"
  "${FLUTTER_MANAGED_DIR}/generated_plugin_registrant.cc"
  "Runner.rc"
  "runner.exe.manifest"
)

# Apply the standard set of build settings. This can be removed for applications
# that need different build settings.
apply_standard_settings(${BINARY_NAME})

# Add preprocessor definitions for the build version.
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION=\"${FLUTTER_VERSION}\"")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_MAJOR=${FLUTTER_VERSION_MAJOR}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_MINOR=${FLUTTER_VERSION_MINOR}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_PATCH=${FLUTTER_VERSION_PATCH}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_BUILD=${FLUTTER_VERSION_BUILD}")

# Disable Windows macros that collide with C++ standard library functions.
target_compile_definitions(${BINARY_NAME} PRIVATE "NOMINMAX")

# Add dependency libraries and include directories. Add any application-specific
# dependencies here.
target_link_libraries(${BINARY_NAME} PRIVATE flutter flutter_wrapper_app)
target_link_libraries(${BINARY_NAME} PRIVATE "dwmapi.lib")
target_include_directories(${BINARY_NAME} PRIVATE "${CMAKE_SOURCE_DIR}")

# Run the Flutter tool portions of the build. This must not be removed.
add_dependencies(${BINARY_NAME} flutter_assemble)

# ==============================================================================
# ðŸ” æ‰˜ç›˜å›¾æ ‡è°ƒè¯•ä¸Žå¤åˆ¶è„šæœ¬
# ==============================================================================

# 1. å®šä¹‰æºè·¯å¾„ (é€šå¸¸åœ¨ windows/runner/resources/app_icon.ico)
# CMAKE_CURRENT_SOURCE_DIR æŒ‡çš„æ˜¯å½“å‰ CMakeLists.txt æ‰€åœ¨çš„ç›®å½• (å³ windows/runner)
set(TRAY_ICON_SRC "${CMAKE_CURRENT_SOURCE_DIR}/resources/app_icon.ico")

# 2. å®šä¹‰ç›®æ ‡è·¯å¾„ (å³ç¼–è¯‘ç”Ÿæˆçš„ exe æ—è¾¹)
set(TRAY_ICON_DEST "${CMAKE_CURRENT_BINARY_DIR}/app_icon.ico")

# 3. æ‰“å°è°ƒè¯•æ—¥å¿— (åœ¨ç¼–è¯‘è¾“å‡ºä¸­æœç´¢ "[Zephyr]" å…³é”®è¯)
message(STATUS "-------------------------------------------------------")
message(STATUS ">>> [Zephyr] æ­£åœ¨æ£€æŸ¥æ‰˜ç›˜å›¾æ ‡...")
message(STATUS ">>> [Zephyr] æºæ–‡ä»¶è·¯å¾„: ${TRAY_ICON_SRC}")
message(STATUS ">>> [Zephyr] ç›®æ ‡è·¯å¾„:   ${TRAY_ICON_DEST}")

if(EXISTS "${TRAY_ICON_SRC}")
    message(STATUS ">>> [Zephyr] âœ… æˆåŠŸæ‰¾åˆ°å›¾æ ‡æ–‡ä»¶ï¼æ­£åœ¨å¤åˆ¶...")
    # æ‰§è¡Œå¤åˆ¶ (COPYONLY è¡¨ç¤ºå¦‚æžœç›®æ ‡å·²å­˜åœ¨ä¸”è¾ƒæ–°ï¼Œåˆ™ä¸å¤åˆ¶)
    configure_file("${TRAY_ICON_SRC}" "${TRAY_ICON_DEST}" COPYONLY)
else()
    # å¦‚æžœæ‰¾ä¸åˆ°ï¼Œæ‰“å°é”™è¯¯è­¦å‘Šï¼Œå¹¶åˆ—å‡º resources ç›®å½•ä¸‹æœ‰ä»€ä¹ˆ
    message(WARNING ">>> [Zephyr] âŒ é”™è¯¯ï¼šåœ¨æºè·¯å¾„æ‰¾ä¸åˆ°å›¾æ ‡æ–‡ä»¶ï¼")
    file(GLOB FILES_IN_RES "${CMAKE_CURRENT_SOURCE_DIR}/resources/*")
    message(STATUS ">>> [Zephyr] resources ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨: ${FILES_IN_RES}")
endif()

message(STATUS "-------------------------------------------------------")
# ==============================================================================