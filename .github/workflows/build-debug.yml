name: Build Android debug APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      CARGO_PROFILE_DEV_DEBUG: 1 
      CARGO_INCREMENTAL: 0

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 释放磁盘空间 (Nuclear Mode)
        run: |
          echo "清理前空间:" && df -h
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/codeql
          docker system prune -a -f
          sudo apt-get clean
          echo "清理后空间:" && df -h

      - name: 解密敏感文件 (git-crypt)
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          sudo apt-get update && sudo apt-get install -y git-crypt
          echo "$GIT_CRYPT_KEY" | base64 -d > ./git-crypt-key
          git-crypt unlock ./git-crypt-key
          rm ./git-crypt-key

      - name: 设置 Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: 设置 Android SDK
        uses: android-actions/setup-android@v3

      - name: 设置 Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: 安装 FVM
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      - name: 使用 FVM 安装 Flutter
        run: |
          fvm install
          fvm use --force
          echo "$GITHUB_WORKSPACE/.fvm/flutter_sdk/bin" >> $GITHUB_PATH

      - name: 安装 Rust 工具链
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: |
            aarch64-linux-android
            armv7-linux-androideabi
            x86_64-linux-android

      - name: 设置 Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29
          add-to-path: true

      - name: 接受 Android Licenses
        run: yes | flutter doctor --android-licenses || true

      - name: 构建 APK (Debug)
        run: flutter build apk --debug --split-per-abi

      - name: 清理敏感文件
        if: always() 
        run: |
          git-crypt lock || true
          rm -f android/key.properties

      - name: 上传 APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: build/app/outputs/flutter-apk/*.apk
