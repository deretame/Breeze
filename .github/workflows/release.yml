name: Breeze Multi-Platform Parallel Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v2.12.6)"
        required: true
        default: "v2.12.6"

permissions:
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. Android æž„å»º (Ubuntu çŽ¯å¢ƒ)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: é‡Šæ”¾ç©ºé—´ (Nuclear Mode)
        run: |
          sudo rm -rf /opt/hostedtoolcache /usr/local/lib/android /usr/share/dotnet /opt/codeql
          sudo mkdir -p /usr/local/lib/android/sdk
          sudo chown -R $USER:$USER /usr/local/lib/android 
          docker system prune -a -f
          sudo apt-get clean

      - name: è§£å¯†æ•æ„Ÿæ–‡ä»¶ (git-crypt)
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          sudo apt-get update && sudo apt-get install -y git-crypt
          echo "$GIT_CRYPT_KEY" | base64 -d > ./git-crypt-key
          git-crypt unlock ./git-crypt-key && rm ./git-crypt-key

      - name: è®¾ç½® Java 21 & SDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: è®¾ç½® Android SDK
        uses: android-actions/setup-android@v3

      - name: è®¾ç½® Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: è®¾ç½® Flutter (FVM)
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          export PATH="$PATH:$HOME/.pub-cache/bin"
          fvm install && fvm use --force
          echo "$GITHUB_WORKSPACE/.fvm/flutter_sdk/bin" >> $GITHUB_PATH

      - name: å®‰è£… Rust (Android ç›®æ ‡)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android

      - name: è¯»å– NDK ç‰ˆæœ¬é…ç½®
        id: ndk-config
        run: |
          NDK_VER=$(grep "ndkVersion" android/app/build.gradle.kts | awk -F'"' '{print $2}')
          echo "ndk_version=$NDK_VER" >> $GITHUB_OUTPUT

      - name: å®‰è£… Android NDK
        run: yes | sdkmanager "ndk;${{ steps.ndk-config.outputs.ndk_version }}"

      - name: è®¾ç½® NDK çŽ¯å¢ƒå˜é‡
        run: |
          NDK_VER=${{ steps.ndk-config.outputs.ndk_version }}
          ANDROID_HOME=${ANDROID_HOME:-$ANDROID_SDK_ROOT}
          NDK_PATH="$ANDROID_HOME/ndk/$NDK_VER"
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: æŽ¥å— Android Licenses
        run: yes | fvm flutter doctor --android-licenses || true

      - name: è¿è¡Œ Android æž„å»ºè„šæœ¬
        env:
          sentry_dsn: ${{ secrets.SENTRY_DSN }}
        run: |
          # yes n è‡ªåŠ¨å›žç­”è„šæœ¬å†…çš„æ›´æ–°è¯¢é—®
          fvm dart ./script/build_apk.dart

      - name: ä¸Šä¼  Android äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/apk/skia/*.apk

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. Linux æž„å»º (Ubuntu çŽ¯å¢ƒ)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… Flatpak æž„å»ºçŽ¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder ninja-build libgtk-3-dev liblzma-dev libgcrypt20-dev libayatana-appindicator3-dev libwebkit2gtk-4.1-dev
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08

      - name: è®¾ç½® Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: è®¾ç½® Flutter (FVM)
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          export PATH="$PATH:$HOME/.pub-cache/bin"
          fvm install && fvm use --force
          echo "$GITHUB_WORKSPACE/.fvm/flutter_sdk/bin" >> $GITHUB_PATH

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-gnu

      - name: æž„å»º Flatpak
        env:
          sentry_dsn: ${{ secrets.SENTRY_DSN }}
        run: |
          fvm flutter build linux --release --dart-define=sentry_dsn=${{ env.sentry_dsn }}
          mkdir -p build-flatpak repo-flatpak
          flatpak-builder --user --force-clean --repo=repo-flatpak --install-deps-from=flathub build-flatpak flatpak/io.github.windy.breeze.yml
          flatpak build-bundle repo-flatpak breeze.flatpak io.github.windy.breeze

      - name: ä¸Šä¼  Linux äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: breeze.flatpak

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. Windows æž„å»º (Windows çŽ¯å¢ƒ)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    runs-on: windows-latest
    steps:
      - name: å…³é—­ Git CRLF è½¬æ¢
        run: git config --global core.autocrlf false

      - uses: actions/checkout@v4

      - name: è®¾ç½® Node.js & pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"
          cache-dependency-path: windows-installer/pnpm-lock.yaml

      - name: è®¾ç½® Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: è®¾ç½® Flutter (FVM)
        run: |
          dart pub global activate fvm
          fvm install && fvm use --force
          # å°† FVM è·¯å¾„åŠ å…¥ Windows çŽ¯å¢ƒå˜é‡
          echo "$((Get-Item .).FullName)\.fvm\flutter_sdk\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: è¿è¡Œ Windows æž„å»ºè„šæœ¬
        env:
          sentry_dsn: ${{ secrets.SENTRY_DSN }}
        run: |
          # 1. å…ˆèŽ·å–é¡¹ç›®ä¾èµ–
          fvm flutter pub get

          # 2. è¿è¡Œè„šæœ¬
          fvm dart ./script/build_windows.dart

      - name: ä¸Šä¼  Windows äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: windows-installer/src-tauri/target/release/windows-installer.exe

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. æ±‡æ€»å‘å¸ƒ (ç­‰å¾…å‰ä¸‰ä¸ªä»»åŠ¡å®Œæˆ)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    needs: [build-android, build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: æå–æ—¥å¿—å¹¶å‡†å¤‡ Release å†…å®¹
        id: prepare
        run: |
          VERSION="${{ github.event.inputs.version }}"
          REPO="${{ github.repository }}"

          # ðŸš€ ä½¿ç”¨ awk ç²¾ç¡®æå–æ—¥å¿—ï¼šç²¾ç¡®åŒ¹é… "## [v2.12.6]" å¼€å¤´çš„è¡Œï¼Œé‡åˆ°ä¸‹ä¸€ä¸ª "## " åœæ­¢
          awk -v ver="## [$VERSION]" 'index($0,ver)==1 {flag=1; print; next} /^## /{if(flag) exit} flag' CHANGELOG.md > changelog_section.txt

          echo "## ðŸ“ æ›´æ–°æ—¥å¿—" > release_body.md
          cat changelog_section.txt >> release_body.md
          echo -e "\n---\n" >> release_body.md
          echo "### ðŸ“¦ æŽ¨èä¸‹è½½" >> release_body.md
          echo "| å¹³å° | ä¸‹è½½é“¾æŽ¥ |" >> release_body.md
          echo "| :--- | :--- |" >> release_body.md
          echo "| **Windows** | [windows-installer.exe](https://github.com/$REPO/releases/download/$VERSION/windows-installer.exe) |" >> release_body.md
          echo "| **Android** | [app-arm64-v8a-release.apk](https://github.com/$REPO/releases/download/$VERSION/app-arm64-v8a-release.apk) |" >> release_body.md
          echo "| **Linux** | [breeze.flatpak](https://github.com/$REPO/releases/download/$VERSION/breeze.flatpak) |" >> release_body.md
          echo -e "\n> ðŸ’¡ **ä¸çŸ¥é“è¯¥ä¸‹è½½å“ªä¸ªæ–‡ä»¶ï¼Ÿ**\n> è¯·æŸ¥çœ‹ [è¯¦ç»†å®‰è£…æŒ‡å—](https://github.com/$REPO#-%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85)ã€‚" >> release_body.md

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Breeze ${{ github.event.inputs.version }}
          body_path: release_body.md
          files: |
            release-assets/android-apks/**/*.apk
            release-assets/linux-flatpak/*.flatpak
            release-assets/windows-exe/windows-installer.exe
