name: Breeze Multi-Platform Parallel Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v2.12.6)"
        required: true
        default: "v2.12.6"

permissions:
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. Android æ„å»º (å« git-crypt & Sentry)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: é‡Šæ”¾ç©ºé—´ (Nuclear Mode)
        run: |
          sudo rm -rf /opt/hostedtoolcache /usr/local/lib/android /usr/share/dotnet /opt/codeql
          sudo mkdir -p /usr/local/lib/android/sdk
          sudo chown -R $USER:$USER /usr/local/lib/android 
          docker system prune -a -f
          sudo apt-get clean

      - name: è§£å¯†æ•æ„Ÿæ–‡ä»¶ (git-crypt)
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          sudo apt-get update && sudo apt-get install -y git-crypt
          echo "$GIT_CRYPT_KEY" | base64 -d > ./git-crypt-key
          git-crypt unlock ./git-crypt-key && rm ./git-crypt-key

      - name: è®¾ç½® Java 21 & SDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: è®¾ç½® Android SDK
        uses: android-actions/setup-android@v3

      - name: è®¾ç½® Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: è®¾ç½® Flutter (FVM)
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          export PATH="$PATH:$HOME/.pub-cache/bin"
          fvm install && fvm use --force
          echo "$GITHUB_WORKSPACE/.fvm/flutter_sdk/bin" >> $GITHUB_PATH

      - name: å®‰è£… Rust (Android ç›®æ ‡)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android

      - name: è¯»å– NDK ç‰ˆæœ¬é…ç½®
        id: ndk-config
        run: |
          NDK_VER=$(grep "ndkVersion" android/app/build.gradle.kts | awk -F'"' '{print $2}')
          echo "ndk_version=$NDK_VER" >> $GITHUB_OUTPUT

      - name: å®‰è£… Android NDK
        run: yes | sdkmanager "ndk;${{ steps.ndk-config.outputs.ndk_version }}"

      - name: è®¾ç½® NDK ç¯å¢ƒå˜é‡
        run: |
          NDK_VER=${{ steps.ndk-config.outputs.ndk_version }}
          ANDROID_HOME=${ANDROID_HOME:-$ANDROID_SDK_ROOT}
          NDK_PATH="$ANDROID_HOME/ndk/$NDK_VER"
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: æ¥å— Android Licenses
        run: yes | fvm flutter doctor --android-licenses || true

      - name: è¿è¡Œ Android æ„å»ºè„šæœ¬
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: fvm dart ./script/build_apk.dart

      - name: ä¸Šä¼  Android äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/apk/skia/*.apk

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. Linux æ„å»º (æ‰‹åŠ¨ Sentry)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: å®‰è£… Flatpak æ„å»ºç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder ninja-build libgtk-3-dev liblzma-dev libgcrypt20-dev libayatana-appindicator3-dev libwebkit2gtk-4.1-dev
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08

      - name: è®¾ç½® Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: è®¾ç½® Flutter (FVM)
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          export PATH="$PATH:$HOME/.pub-cache/bin"
          fvm install && fvm use --force
          echo "$GITHUB_WORKSPACE/.fvm/flutter_sdk/bin" >> $GITHUB_PATH

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-gnu

      - name: æ„å»º Flatpak
        env:
          sentry_dsn: ${{ secrets.SENTRY_DSN }}
        run: |
          fvm flutter build linux --release --dart-define=sentry_dsn=${{ env.sentry_dsn }}
          mkdir -p build-flatpak repo-flatpak
          flatpak-builder --user --force-clean --repo=repo-flatpak --install-deps-from=flathub build-flatpak flatpak/io.github.windy.breeze.yml
          flatpak build-bundle repo-flatpak breeze.flatpak io.github.windy.breeze

      - name: ä¸Šä¼  Linux ç¬¦å·è¡¨åˆ° Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
          sentry-cli debug-files upload --include-sources build/linux/

      - name: ä¸Šä¼  Linux äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: breeze.flatpak

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. Windows æ„å»º (æ‰‹åŠ¨ Sentry)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    runs-on: windows-latest
    steps:
      - name: å…³é—­ Git CRLF è½¬æ¢
        run: git config --global core.autocrlf false
      - uses: actions/checkout@v4

      - name: è®¾ç½® Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: è®¾ç½® Node.js & pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"
          cache-dependency-path: windows-installer/pnpm-lock.yaml

      - name: è®¾ç½® Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: è®¾ç½® Flutter (FVM)
        run: |
          dart pub global activate fvm
          fvm install && fvm use --force
          echo "$((Get-Item .).FullName)\.fvm\flutter_sdk\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: è¿è¡Œ Windows æ„å»ºè„šæœ¬
        env:
          sentry_dsn: ${{ secrets.SENTRY_DSN }}
        run: |
          fvm flutter pub get
          fvm dart ./script/build_windows.dart

      - name: ä¸Šä¼  Windows ç¬¦å·è¡¨åˆ° Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          npm install -g @sentry/cli
          sentry-cli debug-files upload --include-sources build/windows/

      - name: ä¸Šä¼  Windows äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: windows-installer/src-tauri/target/release/windows-installer.exe

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. macOS æ„å»º (è‡ªåŠ¨ Sentry æ’ä»¶)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– & è§£å¯†
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          brew install git-crypt create-dmg
          echo "$GIT_CRYPT_KEY" | base64 --decode > ./git-crypt-key || echo "$GIT_CRYPT_KEY" | base64 -D > ./git-crypt-key
          git-crypt unlock ./git-crypt-key && rm ./git-crypt-key

      - name: è®¾ç½® Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: è®¾ç½® Flutter (FVM)
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          export PATH="$PATH:$HOME/.pub-cache/bin"
          fvm install && fvm use --force
          echo "$GITHUB_WORKSPACE/.fvm/flutter_sdk/bin" >> $GITHUB_PATH

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      - name: æ‹‰å–ä¾èµ– & ä¿®å¤ Podfile
        run: |
          fvm flutter pub get
          if [ -f "macos/Podfile" ]; then
            sed -i '' "s/platform :osx, '[0-9.]*'/platform :osx, '11.0'/g" macos/Podfile
            ruby -i -pe '
              if /flutter_additional_macos_build_settings\(target\)/
                $_ += "      target.build_configurations.each do |config|\n        config.build_settings[\"MACOSX_DEPLOYMENT_TARGET\"] = \"11.0\"\n      end\n"
              end
            ' macos/Podfile
          fi

      - name: ç¼–è¯‘ macOS äº§ç‰© (sentry_dart_plugin ä¼šè‡ªåŠ¨ä¸Šä¼ ç¬¦å·è¡¨)
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: fvm flutter build macos --release

      - name: åˆ¶ä½œ DMG
        run: |
          APP_PATH=$(find build/macos/Build/Products/Release -name "*.app" -maxdepth 1 | head -n 1)
          APP_NAME=$(basename "$APP_PATH")
          rm -f "Breeze-macOS.dmg"
          create-dmg \
            --volname "Breeze Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_NAME" 150 190 \
            --hide-extension "$APP_NAME" \
            --app-drop-link 450 190 \
            "Breeze-macOS.dmg" \
            "$APP_PATH"

      - name: ä¸Šä¼  macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: Breeze-macOS.dmg

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. iOS æ„å»º (å…ç­¾ + è‡ªåŠ¨ Sentry æ’ä»¶)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– & è§£å¯†
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          brew install git-crypt
          echo "$GIT_CRYPT_KEY" | base64 --decode > ./git-crypt-key || echo "$GIT_CRYPT_KEY" | base64 -D > ./git-crypt-key
          git-crypt unlock ./git-crypt-key && rm ./git-crypt-key

      - name: è®¾ç½® Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: è®¾ç½® Flutter (FVM)
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          export PATH="$PATH:$HOME/.pub-cache/bin"
          fvm install && fvm use --force
          echo "$GITHUB_WORKSPACE/.fvm/flutter_sdk/bin" >> $GITHUB_PATH

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: ç¼–è¯‘ iOS (æ— ç­¾)
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          fvm flutter pub get
          fvm flutter build ios --release --no-codesign

      - name: å°è£… IPA
        run: |
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r "Breeze-iOS.ipa" Payload

      - name: ä¸Šä¼  iOS IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: Breeze-iOS.ipa

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 6. æ±‡æ€»å‘å¸ƒè‡³ GitHub Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    needs: [build-android, build-linux, build-windows, build-macos, build-ios]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: æå–æ—¥å¿—å¹¶å‡†å¤‡ Release å†…å®¹
        id: prepare
        run: |
          VERSION="${{ github.event.inputs.version }}"
          REPO="${{ github.repository }}"

          awk -v ver="## [$VERSION]" 'index($0,ver)==1 {flag=1; print; next} /^## /{if(flag) exit} flag' CHANGELOG.md > changelog_section.txt

          echo "## ğŸ“ æ›´æ–°æ—¥å¿—" > release_body.md
          cat changelog_section.txt >> release_body.md
          echo -e "\n---\n" >> release_body.md
          echo "### ğŸ“¦ æ¨èä¸‹è½½" >> release_body.md
          echo "| å¹³å° | ä¸‹è½½é“¾æ¥ |" >> release_body.md
          echo "| :--- | :--- |" >> release_body.md
          echo "| **Windows** | [windows-installer.exe](https://github.com/$REPO/releases/download/$VERSION/windows-installer.exe) |" >> release_body.md
          echo "| **macOS** | [Breeze-macOS.dmg](https://github.com/$REPO/releases/download/$VERSION/Breeze-macOS.dmg) |" >> release_body.md
          echo "| **Android** | [app-arm64-v8a-release.apk](https://github.com/$REPO/releases/download/$VERSION/app-arm64-v8a-release.apk) |" >> release_body.md
          echo "| **iOS** | [Breeze-iOS.ipa](https://github.com/$REPO/releases/download/$VERSION/Breeze-iOS.ipa) |" >> release_body.md
          echo "| **Linux** | [breeze.flatpak](https://github.com/$REPO/releases/download/$VERSION/breeze.flatpak) |" >> release_body.md
          echo -e "\n> ğŸ’¡ **ä¸çŸ¥é“è¯¥ä¸‹è½½å“ªä¸ªæ–‡ä»¶ï¼Ÿ**\n> è¯·æŸ¥çœ‹ [è¯¦ç»†å®‰è£…æŒ‡å—](https://github.com/$REPO#-%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85)ã€‚" >> release_body.md

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Breeze ${{ github.event.inputs.version }}
          body_path: release_body.md
          files: |
            release-assets/android-apks/**/*.apk
            release-assets/linux-flatpak/*.flatpak
            release-assets/windows-exe/windows-installer.exe
            release-assets/macos-dmg/Breeze-macOS.dmg
            release-assets/ios-ipa/Breeze-iOS.ipa

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 7. è‡ªåŠ¨æ›´æ–° Homebrew Tap (ä»…é™ macOS Cask)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-homebrew:
    needs: [publish]
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡º Homebrew Tap ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: deretame/homebrew-Breeze
          token: ${{ secrets.HOMEBREW_GITHUB_TOKEN }} 
          path: homebrew-Breeze

      - name: ä¸‹è½½ macOS äº§ç‰©å¹¶è®¡ç®— SHA256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          # æå–çº¯æ•°å­—ç‰ˆæœ¬å· (ä¾‹å¦‚ v2.12.6 æå–ä¸º 2.12.6)
          CLEAN_VERSION="${VERSION#v}"
          echo "CLEAN_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
          
          # ä»…ä»åˆšæ‰å‘å¸ƒçš„ Release ä¸­ä¸‹è½½ macOS çš„ DMG æ–‡ä»¶
          gh release download "$VERSION" --repo "${{ github.repository }}" --pattern "Breeze-macOS.dmg"
          
          # è®¡ç®—å“ˆå¸Œ
          DMG_SHA256=$(sha256sum Breeze-macOS.dmg | awk '{ print $1 }')
          
          echo "DMG_SHA256: $DMG_SHA256"
          echo "DMG_SHA256=$DMG_SHA256" >> $GITHUB_ENV

      - name: æ›´æ–° Homebrew Cask æ–‡ä»¶
        working-directory: ./homebrew-Breeze
        run: |
          # æŸ¥æ‰¾ breeze.rb æ–‡ä»¶
          RB_FILE=$(find . -name "breeze.rb" | head -n 1)
          
          if [ -z "$RB_FILE" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° breeze.rb æ–‡ä»¶"
            exit 1
          fi

          # æ›¿æ¢ version (å¯¹åº” cask ä¸­çš„ version "2.12.6")
          sed -i "s/version \".*\"/version \"${{ env.CLEAN_VERSION }}\"/" "$RB_FILE"
          
          # æ›¿æ¢ sha256 (å¯¹åº” cask ä¸­çš„ sha256 "...")
          sed -i "s/sha256 \".*\"/sha256 \"${{ env.DMG_SHA256 }}\"/" "$RB_FILE"

      - name: æäº¤å¹¶æ¨é€åˆ° Homebrew
        working-directory: ./homebrew-Breeze
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update macOS Cask to ${{ github.event.inputs.version }}"
          git push