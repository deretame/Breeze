name: Test macOS Build & DMG

on:
  workflow_dispatch:

jobs:
  test-build-macos:
    runs-on: macos-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装系统依赖
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          brew install git-crypt

          # 解密敏感文件
          echo "$GIT_CRYPT_KEY" | base64 --decode > ./git-crypt-key || echo "$GIT_CRYPT_KEY" | base64 -D > ./git-crypt-key
          git-crypt unlock ./git-crypt-key && rm ./git-crypt-key

      - name: 设置 Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: 设置 Flutter (FVM)
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          export PATH="$PATH:$HOME/.pub-cache/bin"
          fvm install && fvm use --force
          echo "$GITHUB_WORKSPACE/.fvm/flutter_sdk/bin" >> $GITHUB_PATH

      - name: 安装 Rust 工具链
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      - name: 安装打包工具
        run: brew install create-dmg

      - name: 拉取依赖
        run: fvm flutter pub get

      - name: 修复 Podfile 最低版本 & 安装 CocoaPods 依赖
        run: |
          cd macos

          # flutter pub get 自动生成的 Podfile 可能引用旧 platform 版本
          if [ -f "Podfile" ]; then
            sed -i '' "s/platform :osx, '[0-9.]*'/platform :osx, '11.0'/g" Podfile
            echo "=== Patched Podfile ==="
            cat Podfile
          fi

          pod install --repo-update
          cd ..

      - name: 编译 Flutter macOS 产物
        run: fvm flutter build macos --release

      - name: 制作 DMG
        run: |
          APP_PATH=$(find build/macos/Build/Products/Release -name "*.app" -maxdepth 1 | head -n 1)
          APP_NAME=$(basename "$APP_PATH")
          rm -f "Breeze-macOS-Test.dmg"
          create-dmg \
            --volname "Breeze Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_NAME" 150 190 \
            --hide-extension "$APP_NAME" \
            --app-drop-link 450 190 \
            "Breeze-macOS-Test.dmg" \
            "$APP_PATH"

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: macOS-DMG-Test
          path: Breeze-macOS-Test.dmg
          retention-days: 3
